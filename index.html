
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>منصة الرياضيات</title>
<style>
:root{--bg:#f7fbff;--panel:#ffffffd9;--ink:#0f172a;--ring:#e5e7eb;--brand:#06b6d4;--accent:#8b5cf6;--shadow:0 10px 40px rgba(2,6,23,.08)}
*{box-sizing:border-box}html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
a{color:inherit;text-decoration:none}.wrap{max-width:1200px;margin:0 auto;padding:16px}
.glass{backdrop-filter:blur(8px);background:var(--panel);border:1px solid var(--ring);box-shadow:var(--shadow);border-radius:16px}
.header{position:sticky;top:0;z-index:50;margin:12px;padding:10px 14px}.header-inner{display:flex;align-items:center;justify-content:space-between;gap:12px}
.brand{display:flex;align-items:center;gap:12px}.logo{width:54px;height:54px;border-radius:16px;border:1px solid var(--ring);object-fit:cover}
h1{margin:0;font-size:20px}.badge{display:none;font-size:11px;background:linear-gradient(90deg,#99f6e4,#ddd6fe);color:#0f172a;border:1px solid #c7d2fe;padding:4px 10px;border-radius:999px}
.controls{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
input[type="text"],input[type="email"],input[type="password"],textarea,select{border:1px solid var(--ring);background:#fff;color:#0f172a;border-radius:12px;padding:10px 12px;font-size:14px;outline:none;min-width:160px}
textarea{min-height:84px;resize:vertical}
input[type="file"]{font-size:13px}
.btn{background:linear-gradient(90deg,var(--brand),var(--accent));color:#fff;border:none;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:700}
.btn.secondary{background:#eef2ff;color:#3b0764;border:1px solid #c7d2fe}.btn.ghost{background:transparent;color:#334155;border:1px dashed var(--ring)}
.grid{display:grid;gap:16px;margin:16px 12px}@media(min-width:1000px){.grid{grid-template-columns:1.5fr .5fr}}
.panel .head{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--ring)}.panel .body{padding:16px}
.post{display:grid;grid-template-columns:1fr;gap:8px;padding:14px;border-bottom:1px solid var(--ring)}.post:last-child{border-bottom:0}
.meta{font-size:12px;color:#64748b}.tag{font-size:11px;background:#e0f2fe;color:#155e75;border:1px solid #bae6fd;border-radius:999px;padding:3px 8px;margin-inline-start:6px}
.media{margin-top:10px;border-radius:14px;overflow:hidden;border:1px solid var(--ring)}.media iframe,.media img,.media video{width:100%;height:auto;display:block}
.media .fallback a{display:inline-block;padding:10px}
.empty{text-align:center;color:#64748b;padding:24px}
.list li{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 0;border-bottom:1px dashed var(--ring)}.list li:last-child{border-bottom:0}
.pill{padding:4px 8px;border-radius:999px;background:#f1f5f9;color:#0f172a;font-size:12px;border:1px solid var(--ring)}
.row{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}.row>*{flex:1 1 180px}
.tool{display:flex;gap:6px;margin-top:8px}.tool .mini{font-size:12px;padding:6px 10px;border-radius:10px;border:1px solid var(--ring);background:#fff;cursor:pointer}
dialog{border:none;border-radius:16px;max-width:860px;width:96vw;padding:0;box-shadow:var(--shadow)}dialog::backdrop{background:rgba(2,6,23,.25)}
.dialog-head{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--ring)}.dialog-body{padding:16px}
.toast{position:fixed;inset-inline-start:50%;bottom:20px;transform:translateX(-50%);background:#10b981;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);display:none;z-index:100}.toast.err{background:#ef4444}
</style>
</head>
<body>
  <div class="header glass">
    <div class="header-inner">
      <div class="brand">
        <img class="logo" src="data:image/jpeg;base64,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" alt="LOGO"/>
        <div>
          <h1>منصة الرياضيات <span id="adminBadge" class="badge">مشرف مفعل</span></h1>
          <div class="meta" id="userLine">غير مسجل دخول</div>
        </div>
      </div>
      <div class="controls">
        <input id="search" type="text" placeholder="ابحث في المنشورات"/>
        <select id="typeFilter">
          <option value="">الكل</option><option>عام</option><option>سؤال</option><option>تذكير</option>
          <option>فيديو</option><option>صور</option><option>ملف</option><option>إعلان</option>
        </select>
        <button class="btn secondary" id="btnAssignments">الواجبات</button>
        <button class="btn secondary" id="btnExams">الاختبارات</button>
        <button class="btn" id="btnLogin">تسجيل الدخول</button>
        <button class="btn ghost" id="btnLogout" style="display:none">تسجيل الخروج</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <section class="panel glass" id="feedPanel">
        <div class="head"><strong>المنشورات</strong><span class="meta" id="count"></span></div>
        <div class="body" id="feed"></div>
      </section>

      <aside class="panel glass">
        <div class="head"><strong>إجراءات المشرف</strong></div>
        <div class="body">
          <div class="row">
            <button class="btn admin-only" id="openCreatePost" style="display:none">+ منشور</button>
            <button class="btn admin-only" id="openCreateAssign" style="display:none">+ واجب</button>
            <button class="btn admin-only" id="openCreateExam" style="display:none">+ اختبار</button>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Auth -->
  <dialog class="glass" id="dlgAuth">
    <div class="dialog-head"><strong>تسجيل دخول المشرف</strong><button class="btn ghost" onclick="dlgAuth.close()">إغلاق</button></div>
    <div class="dialog-body">
      <form id="formAuth">
        <div class="row">
          <input id="authEmail" type="email" placeholder="البريد" required/>
          <input id="authPass" type="password" placeholder="كلمة المرور" required/>
        </div>
        <div class="row"><button class="btn" type="submit">دخول</button></div>
      </form>
    </div>
  </dialog>

  <!-- Post (multi attachments) -->
  <dialog class="glass" id="dlgPost">
    <div class="dialog-head"><strong id="postDlgTitle">منشور جديد</strong><button class="btn ghost" onclick="dlgPost.close()">إغلاق</button></div>
    <div class="dialog-body">
      <form id="formPost">
        <input type="hidden" id="postId"/>
        <div class="row"><input type="text" id="postText" placeholder="نص المنشور" required/></div>
        <div class="row">
          <textarea id="postMedia" placeholder="أضف روابط مرفقات (رابط في كل سطر) — اختياري"></textarea>
          <select id="postType"><option>عام</option><option>سؤال</option><option>تذكير</option><option>فيديو</option><option>صور</option><option>ملف</option><option>إعلان</option></select>
        </div>
        <div class="row"><input type="file" id="postFile" multiple accept="image/*,video/*,.pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx"/></div>
        <div class="row"><button class="btn" type="submit">حفظ</button></div>
      </form>
    </div>
  </dialog>

  <!-- Assignment -->
  <dialog class="glass" id="dlgAssign">
    <div class="dialog-head"><strong id="assignDlgTitle">إضافة واجب</strong><button class="btn ghost" onclick="dlgAssign.close()">إغلاق</button></div>
    <div class="dialog-body">
      <form id="formAssign">
        <input type="hidden" id="assignId"/>
        <div class="row"><input type="text" id="assignTitle" placeholder="عنوان الواجب" required/></div>
        <div class="row"><input type="text" id="assignGrade" placeholder="الصف/الفصل (اختياري)"/></div>
        <div class="row"><textarea id="assignMedia" placeholder="روابط مرفقات (سطر لكل رابط) — اختياري"></textarea></div>
        <div class="row"><input type="file" id="assignFile" multiple accept="image/*,video/*,.pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx"/></div>
        <div class="row"><button class="btn" type="submit">حفظ</button></div>
      </form>
    </div>
  </dialog>

  <!-- Exam -->
  <dialog class="glass" id="dlgExam">
    <div class="dialog-head"><strong id="examDlgTitle">إضافة اختبار</strong><button class="btn ghost" onclick="dlgExam.close()">إغلاق</button></div>
    <div class="dialog-body">
      <form id="formExam">
        <input type="hidden" id="examId"/>
        <div class="row"><input type="text" id="examTitle" placeholder="عنوان الاختبار" required/></div>
        <div class="row"><input type="text" id="examWeight" placeholder="الوزن (اختياري مثال 30%)"/></div>
        <div class="row"><textarea id="examMedia" placeholder="روابط مرفقات (سطر لكل رابط) — اختياري"></textarea></div>
        <div class="row"><input type="file" id="examFile" multiple accept="image/*,video/*,.pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx"/></div>
        <div class="row"><button class="btn" type="submit">حفظ</button></div>
      </form>
    </div>
  </dialog>

  <!-- Panels -->
  <dialog class="glass" id="panelAssignments">
    <div class="dialog-head"><strong>الواجبات</strong><button class="btn ghost" onclick="panelAssignments.close()">إغلاق</button></div>
    <div class="dialog-body"><ul class="list" id="listAssignments"></ul></div>
  </dialog>
  <dialog class="glass" id="panelExams">
    <div class="dialog-head"><strong>الاختبارات</strong><button class="btn ghost" onclick="panelExams.close()">إغلاق</button></div>
    <div class="dialog-body"><ul class="list" id="listExams"></ul></div>
  </dialog>

  <div class="toast" id="toast"></div>

<script type="module">
// ===== Firebase =====
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyD6rszy7D-XXbDnrs_vikBkGZueOpr-q0M",
  authDomain: "math-7b268.firebaseapp.com",
  projectId: "math-7b268",
  storageBucket: "math-7b268.appspot.com",
  messagingSenderId: "32015049723",
  appId: "1:32015049723:web:6791b683596dc7a032215e",
  measurementId: "G-TPG58YPEHY"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// === روابط فقط أم رفع؟ ===
const ENABLE_STORAGE = true;

// ==== UI ====
const $=id=>document.getElementById(id);
const adminBadge=$("adminBadge"), userLine=$("userLine");
const feed=$("feed"), count=$("count"), search=$("search"), typeFilter=$("typeFilter");
const btnAssignments=$("btnAssignments"), btnExams=$("btnExams"), panelAssignments=$("panelAssignments"), panelExams=$("panelExams");
const listAssignments=$("listAssignments"), listExams=$("listExams");
const btnLogin=$("btnLogin"), btnLogout=$("btnLogout"), dlgAuth=$("dlgAuth"), formAuth=$("formAuth"), authEmail=$("authEmail"), authPass=$("authPass");
const openCreatePost=$("openCreatePost"), openCreateAssign=$("openCreateAssign"), openCreateExam=$("openCreateExam");
const dlgPost=$("dlgPost"), dlgAssign=$("dlgAssign"), dlgExam=$("dlgExam");
const formPost=$("formPost"), postText=$("postText"), postMedia=$("postMedia"), postType=$("postType"), postFile=$("postFile"), postId=$("postId");
const formAssign=$("formAssign"), assignTitle=$("assignTitle"), assignGrade=$("assignGrade"), assignMedia=$("assignMedia"), assignFile=$("assignFile"), assignId=$("assignId");
const formExam=$("formExam"), examTitle=$("examTitle"), examWeight=$("examWeight"), examMedia=$("examMedia"), examFile=$("examFile"), examId=$("examId");

function toast(msg, ok=true){ const t=$("toast"); t.className = ok? "toast":"toast err"; t.textContent=msg; t.style.display="block"; setTimeout(()=>t.style.display="none", 3500); }
let isAdmin=false;
async function checkAdmin(email){ try{ const s=await getDoc(doc(db,"config","admins")); const emails=s.exists()?(s.data().emails||[]):[]; return !!email && emails.includes(email); }catch{ return false } }
function setAdminUI(on){ isAdmin=!!on; adminBadge.style.display=on?'inline-flex':'none'; document.querySelectorAll(".admin-only").forEach(el=>el.style.display=on?'inline-flex':'none'); }

btnLogin.addEventListener("click",()=>dlgAuth.showModal());
btnLogout.addEventListener("click",async()=>{ await signOut(auth); toast("تم تسجيل الخروج"); });
formAuth.addEventListener("submit",async (e)=>{ e.preventDefault(); try{ await signInWithEmailAndPassword(auth, authEmail.value, authPass.value); dlgAuth.close(); toast("تم تسجيل الدخول"); }catch(err){ toast("خطأ في الدخول: "+(err.code||''), false); } });
onAuthStateChanged(auth, async (user)=>{ const email=user?.email||""; userLine.textContent=user?("سجّل الدخول: "+email):"غير مسجل دخول"; btnLogin.style.display=user?"none":"inline-flex"; btnLogout.style.display=user?"inline-flex":"none"; const admin=await checkAdmin(email); setAdminUI(admin); });

function fmtDate(ts){ if(!ts) return ""; const d=ts.toDate? ts.toDate(): new Date(ts); return d.toLocaleDateString('ar',{year:'numeric',month:'long',day:'numeric'})+" "+d.toLocaleTimeString('ar',{hour:'2-digit',minute:'2-digit'}) }
function toDirectURL(raw){ if(!raw) return ""; let url=raw.trim(); try{ const u=new URL(url); const host=u.host;
  if(/youtube\.com|youtu\.be/.test(host)){ if(u.pathname.startsWith("/shorts/")){ const id=u.pathname.split("/")[2]; return "yt-embed:https://www.youtube.com/embed/"+id; } const v=u.searchParams.get("v"); if(v) return "yt-embed:https://www.youtube.com/embed/"+v; if(host.includes("youtu.be")){ const id=u.pathname.slice(1); return "yt-embed:https://www.youtube.com/embed/"+id; } }
  if(host.includes("drive.google.com")){ let id=""; const m=u.pathname.match(/\/file\/d\/([^/]+)/); if(m) id=m[1]; if(!id) id=u.searchParams.get("id")||""; if(id) return "https://drive.google.com/uc?export=download&id="+id; }
  if(host.includes("dropbox.com")){ u.searchParams.delete("dl"); u.searchParams.set("raw","1"); return u.toString(); }
  return url;
}catch(_){ return url; }}
function renderAttachment(url){ const direct=toDirectURL(url); if(direct.startsWith("yt-embed:")){ const src=direct.replace("yt-embed:",""); return `<div class='media'><iframe src='${src}' frameborder='0' allowfullscreen loading='lazy'></iframe></div>`; }
  return `<div class='media'>
    <img src='${direct}' referrerpolicy='no-referrer' loading='lazy'
         onerror="this.style.display='none'; this.parentElement.querySelector('video').style.display='block'">
    <video controls src='${direct}' style="display:none"
           onerror="this.style.display='none'; this.parentElement.querySelector('.fallback').style.display='block'"></video>
    <div class='fallback' style="display:none"><a href='${direct}' target='_blank' rel='noopener'>فتح الرابط</a></div>
  </div>`; }
async function uploadMany(fileInput){ const files=Array.from(fileInput.files||[]); const urls=[]; for(const f of files){ if(!ENABLE_STORAGE) throw new Error("storage-disabled"); const r=ref(storage,`uploads/${Date.now()}_${Math.random().toString(36).slice(2)}_${f.name}`); await uploadBytes(r,f); urls.push(await getDownloadURL(r)); } return urls; }
function parseLinks(textarea){ return (textarea.value||"").split(/\n+/).map(s=>s.trim()).filter(Boolean); }

let allPosts=[];
function postHTML(p){ const media = Array.isArray(p.media)? p.media : (p.media? [p.media] : []); const mediaHtml = media.map(renderAttachment).join(""); return `<div class="post">
  <div><div><span class="tag">${p.type||"عام"}</span></div>
  <div class="meta">${fmtDate(p.createdAt)}</div>
  <div>${p.text||""}</div>
  ${mediaHtml}
  ${isAdmin?`<div class='tool'><button class='mini' data-ed='post' data-id='${p.id}'>تعديل</button><button class='mini' data-del='post' data-id='${p.id}'>حذف</button></div>`:""}
  </div></div>`; }
function renderFeed(){ const q=(search.value||"").trim(); const t=(typeFilter.value||""); const list=allPosts.filter(p=>(!t||p.type===t)&&((p.text||"")+ (Array.isArray(p.media)?p.media.join(" "):p.media||"")).includes(q)); feed.innerHTML=list.length? "":'<div class="empty">لا توجد منشورات</div>'; list.forEach(p=> feed.insertAdjacentHTML('beforeend', postHTML(p)) ); count.textContent=list.length?("العدد: "+list.length):""; }
onSnapshot(query(collection(db,"posts"), orderBy("createdAt","desc")), snap=>{ allPosts=snap.docs.map(d=>({id:d.id, ...d.data()})); renderFeed(); });
search.addEventListener("input",renderFeed); typeFilter.addEventListener("change",renderFeed);

function liWithControls(type, id, leftHTML, ts){ return `<li>
  <span>${leftHTML}</span>
  <span>
    <span class="pill">${fmtDate(ts)} </span>
    ${isAdmin?`<span class="tool"><button class='mini' data-ed='${type}' data-id='${id}'>تعديل</button><button class='mini' data-del='${type}' data-id='${id}'>حذف</button></span>`:""}
  </span></li>`; }
onSnapshot(query(collection(db,"assignments"), orderBy("createdAt","desc")), snap=>{ listAssignments.innerHTML=""; if(snap.empty){ listAssignments.innerHTML='<div class="empty">لا توجد واجبات</div>'; return; } snap.forEach(d=>{ const a=d.data(); const media = Array.isArray(a.media)?a.media:(a.media?[a.media]:[]); const blocks = media.map(u=>renderAttachment(u)).join(""); listAssignments.insertAdjacentHTML('beforeend', liWithControls('assign', d.id, `${a.title}${a.grade?(" — "+a.grade):""}${blocks}`, a.createdAt)); }); });
onSnapshot(query(collection(db,"exams"), orderBy("createdAt","desc")), snap=>{ listExams.innerHTML=""; if(snap.empty){ listExams.innerHTML='<div class="empty">لا توجد اختبارات</div>'; return; } snap.forEach(d=>{ const e=d.data(); const media = Array.isArray(e.media)?e.media:(e.media?[e.media]:[]); const blocks = media.map(u=>renderAttachment(u)).join(""); listExams.insertAdjacentHTML('beforeend', liWithControls('exam', d.id, `${e.title}${e.weight?(' • '+e.weight):''}${blocks}`, e.createdAt)); }); });

openCreatePost.addEventListener("click",()=>{ if(!isAdmin) return toast("خاص بالمشرف فقط",false); postId.value=""; postText.value=""; postMedia.value=""; postType.value="عام"; document.getElementById("postDlgTitle").textContent="منشور جديد"; dlgPost.showModal(); });
openCreateAssign.addEventListener("click",()=>{ if(!isAdmin) return toast("خاص بالمشرف فقط",false); assignId.value=""; assignTitle.value=""; assignGrade.value=""; assignMedia.value=""; document.getElementById("assignDlgTitle").textContent="إضافة واجب"; dlgAssign.showModal(); });
openCreateExam.addEventListener("click",()=>{ if(!isAdmin) return toast("خاص بالمشرف فقط",false); examId.value=""; examTitle.value=""; examWeight.value=""; examMedia.value=""; document.getElementById("examDlgTitle").textContent="إضافة اختبار"; dlgExam.showModal(); });

async function collectMedia(textarea, fileInput){ let urls=parseLinks(textarea); if(fileInput.files.length>0){ try{ urls = urls.concat(await uploadMany(fileInput)); }catch(upErr){ if(upErr.message==='storage-disabled') toast('الرفع متوقف: فعّل Storage أو استخدم روابط', false); else throw upErr; } } return urls; }
formPost.addEventListener("submit", async (e)=>{ e.preventDefault(); if(!isAdmin) return; try{ const mediaList = await collectMedia(postMedia, postFile); const data={ text:postText.value.trim(), media:mediaList, type:postType.value, createdAt: serverTimestamp() }; if(postId.value){ await updateDoc(doc(db,"posts",postId.value), data); toast("تم تحديث المنشور"); } else { await addDoc(collection(db,"posts"), data); toast("تم نشر المنشور"); } dlgPost.close(); }catch(err){ console.error(err); toast("تعذر الحفظ: "+(err.code||err.message), false); } });
formAssign.addEventListener("submit", async (e)=>{ e.preventDefault(); if(!isAdmin) return; try{ const mediaList = await collectMedia(assignMedia, assignFile); const data={ title:assignTitle.value.trim(), grade:assignGrade.value.trim(), media:mediaList, createdAt: serverTimestamp() }; if(assignId.value){ await updateDoc(doc(db,"assignments",assignId.value), data); toast("تم تحديث الواجب"); } else { await addDoc(collection(db,"assignments"), data); toast("تم حفظ الواجب"); } dlgAssign.close(); }catch(err){ console.error(err); toast("تعذر الحفظ: "+(err.code||err.message), false); } });
formExam.addEventListener("submit", async (e)=>{ e.preventDefault(); if(!isAdmin) return; try{ const mediaList = await collectMedia(examMedia, examFile); const data={ title:examTitle.value.trim(), weight:examWeight.value.trim(), media:mediaList, createdAt: serverTimestamp() }; if(examId.value){ await updateDoc(doc(db,"exams",examId.value), data); toast("تم تحديث الاختبار"); } else { await addDoc(collection(db,"exams"), data); toast("تم حفظ الاختبار"); } dlgExam.close(); }catch(err){ console.error(err); toast("تعذر الحفظ: "+(err.code||err.message), false); } });

document.addEventListener('click', async (e)=>{ const ed=e.target.getAttribute('data-ed'); const del=e.target.getAttribute('data-del'); const id=e.target.getAttribute('data-id'); if(ed) { if(!isAdmin) return; try { const c=ed==='post'?'posts': ed==='assign'?'assignments':'exams'; const snap=await getDoc(doc(db,c,id)); if(!snap.exists()) return; const d=snap.data(); if(ed==='post') { postId.value=id; postText.value=d.text||''; postMedia.value=(Array.isArray(d.media)?d.media.join('\n'):(d.media||'')); postType.value=d.type||'عام'; dlgPost.showModal(); } else if(ed==='assign') { assignId.value=id; assignTitle.value=d.title||''; assignGrade.value=d.grade||''; assignMedia.value=(Array.isArray(d.media)?d.media.join('\n'):(d.media||'')); dlgAssign.showModal(); } else if(ed==='exam') { examId.value=id; examTitle.value=d.title||''; examWeight.value=d.weight||''; examMedia.value=(Array.isArray(d.media)?d.media.join('\n'):(d.media||'')); dlgExam.showModal(); } } catch(err){ toast('تعذر فتح التعديل: '+(err.code||err.message), false); } } if(del) { if(!isAdmin) return; if(!confirm('حذف نهائي؟')) return; try { const c=del==='post'?'posts': del==='assign'?'assignments':'exams'; await deleteDoc(doc(db,c,id)); toast('تم الحذف', true); } catch(err){ toast('تعذر الحذف: '+(err.code||err.message), false); } } });

btnAssignments.addEventListener("click",()=>panelAssignments.showModal());
btnExams.addEventListener("click",()=>panelExams.showModal());
</script>
</body>
</html>
